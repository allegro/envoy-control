version: '3'

services:
  consul:
    container_name: consul
    image: consul:1.5.3
    ports:
      - "18500:8500"
      - "18300:8300"
    volumes:
      - ./tmp/config:/config
      - ./tmp/_data/consul:/data
    command: agent -server -data-dir=/data -bind 0.0.0.0 -client 0.0.0.0 -bootstrap-expect=1 -ui

  http-echo:
    depends_on:
      - consul
    build:
      context: ./service
      dockerfile: Dockerfile
    ports: 
      - "80:80"

  tracing:
    build:
      context: ./tracing
    image: envoyproxy:tracing
    restart: "no"
    deploy:
      replicas: 0

  flask-service:
    build:
      context: ./flask
    restart: "no"
    deploy:
      replicas: 0

  service1:
    depends_on: 
      - consul
    image: envoyproxy:tracing
    volumes:
      - ./service1/service1-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=1
      - PORT=8070
    expose:
      - 8070
      - 9999
    ports:
      - "10001:9999"

  service2:
    depends_on: 
      - consul
    image: envoyproxy:tracing
    volumes:
      - ./service2/service2-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=2
      - PORT=8070
    expose:
      - 8070
      - 9999
    ports:
      - "10002:9999"


  service3:
    depends_on: 
      - consul
    image: envoyproxy:tracing
    volumes:
      - ./service3/service3-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=3
      - PORT=8070
    expose:
      - 8070
      - 9999
    ports:
      - "10003:9999"


  jaeger:
    depends_on:
      - consul
    build:
      context: ./jaeger
      dockerfile: Dockerfile
    environment:
    - COLLECTOR_ZIPKIN_HOST_PORT=9411
    ports:
    - "9411:9411"
    - "16686:16686"
    - "16687:16687"

  front-proxy:
    build:
      context: ./envoy
      dockerfile: Dockerfile
    ports:
      - "9999:9999"
      - "31000:31000"
      - "31001:31001"
      - "8000:8000"

  envoy-control:
    container_name: envoy-control
    build:
      context: ../
      dockerfile: tools/envoy-control/Dockerfile
    ports:
      - "8080:8080"
      - "50000:50000"
    # here you can define path to your own config
    volumes:
      - "../envoy-control-runner/src/main/resources/application-docker.yaml:/var/tmp/config/application.yaml"
    depends_on:
      - consul
    environment:
      - ENVOY_CONTROL_PROPERTIES=
