version: '3'

services:
  consul:
    container_name: consul
    image: consul:1.10.12
    ports:
      - "18500:8500"
      - "18300:8300"
    volumes:
      - ./tmp/config:/config
      - ./tmp/_data/consul:/data
    command: agent -server -data-dir=/data -bind 0.0.0.0 -client 0.0.0.0 -bootstrap-expect=1 -ui

  s1-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile
    container_name: s1-envoy
    depends_on:
      - consul
    environment:
      - SERVICE_NAME=s1
      - SERVICE_HOST=s1
      - SERVICE_PORT=8070
      - HEALTH_CHECK=/health-check
    ports:
      - "30000:31000"
      - "30001:31001"
      - "30002:9999"

  s1:
    container_name: s1
    build:
      context: ./tracing
      dockerfile: Dockerfile
    volumes:
      - ./service1/service1-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=s1
      - PORT=8070
      - ENVOY_HOST=s1-envoy
    ports:
      - "10001:8070"

  s2-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile
    container_name: s2-envoy
    depends_on:
      - consul
    environment:
      - SERVICE_NAME=s2
      - SERVICE_HOST=s2
      - SERVICE_PORT=8070
      - HEALTH_CHECK=/health-check
    ports:
      - "31000:31000"
      - "31001:31001"
      - "31002:9999"

  s2:
    container_name: s2
    build:
      context: ./tracing
      dockerfile: Dockerfile
    volumes:
      - ./service1/service1-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=s2
      - PORT=8070
      - ENVOY_HOST=s2-envoy
    ports:
      - "11001:8070"

  s3-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile
    container_name: s3-envoy
    depends_on:
      - consul
    environment:
      - SERVICE_NAME=s3
      - SERVICE_HOST=s3
      - SERVICE_PORT=8070
      - HEALTH_CHECK=/health-check
    ports:
      - "32000:31000"
      - "32001:31001"
      - "32002:9999"

  s3:
    container_name: s3
    build:
      context: ./tracing
      dockerfile: Dockerfile
    volumes:
      - ./service1/service1-envoy.yaml:/etc/service-envoy.yaml
    environment:
      - SERVICE_NAME=s3
      - PORT=8070
      - ENVOY_HOST=s3-envoy
    ports:
      - "12001:8070"

  jaeger:
    depends_on:
      - consul
    build:
      context: ./jaeger
      dockerfile: Dockerfile
    environment:
    - COLLECTOR_ZIPKIN_HOST_PORT=9411
    ports:
    - "9411:9411"
    - "16686:16686"
    - "16687:16687"

  envoy-control:
    container_name: envoy-control
    build:
      context: ../
      dockerfile: tools/envoy-control/Dockerfile
    ports:
      - "8080:8080"
      - "50000:50000"
    # here you can define path to your own config
    volumes:
      - "../envoy-control-runner/src/main/resources/application-docker.yaml:/var/tmp/config/application.yaml"
    depends_on:
      - consul
    environment:
      - ENVOY_CONTROL_PROPERTIES=
